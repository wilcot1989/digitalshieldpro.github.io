name: Generate New Article with Claude AI

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Article topic (e.g., "Surfshark VPN Review 2026")'
        required: true
        type: string
      article_type:
        description: 'Type of article'
        required: true
        type: choice
        options:
          - product-review
          - comparison
          - how-to-guide
          - best-of-list
      category:
        description: 'Category'
        required: true
        type: choice
        options:
          - vpn
          - password-managers
          - ai-tools
          - privacy
      slug:
        description: 'URL slug (e.g., "surfshark-review-2026")'
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate article with Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TOPIC="${{ github.event.inputs.topic }}"
          TYPE="${{ github.event.inputs.article_type }}"
          CATEGORY="${{ github.event.inputs.category }}"
          SLUG="${{ github.event.inputs.slug }}"
          DATE=$(date +%Y-%m-%dT%H:%M:%S+01:00)
          FILENAME="content/posts/${SLUG}.md"

          # Build the prompt based on article type
          case "$TYPE" in
            product-review)
              INSTRUCTIONS="Write a comprehensive product review article (3000+ words). Include: overall rating out of 10, detailed feature breakdown, speed/performance test results, pros and cons, pricing table, comparison with competitors, FAQ section (5+ questions), and a final verdict."
              ;;
            comparison)
              INSTRUCTIONS="Write a detailed head-to-head comparison article (2500+ words). Include: comparison table at the top, category-by-category breakdown (speed, security, features, pricing, ease of use), clear winner per category, overall recommendation, and FAQ section."
              ;;
            how-to-guide)
              INSTRUCTIONS="Write a comprehensive how-to guide (2500+ words). Include: step-by-step instructions, tool recommendations with links, common mistakes to avoid, FAQ section, and related guides section."
              ;;
            best-of-list)
              INSTRUCTIONS="Write a detailed best-of list article (3000+ words). Include: quick comparison table, detailed review of each product (5+), pros and cons for each, pricing comparison, how we tested section, and FAQ."
              ;;
          esac

          # Create the API request
          PROMPT="You are a cybersecurity content writer for digitalshieldpro.com. Write a Hugo markdown article about: ${TOPIC}

          ${INSTRUCTIONS}

          IMPORTANT FORMATTING RULES:
          - Start with Hugo front matter (title, date: ${DATE}, description, categories: [\"${CATEGORY}\"], tags, keywords, affiliate: true)
          - Use these affiliate links where relevant:
            * NordVPN: https://go.nordvpn.net/aff_c?offer_id=612&aff_id=141337&url_id=14830
            * NordPass: https://go.nordpass.io/aff_c?offer_id=488&aff_id=141337&url_id=9356
            * Bitdefender (AWIN): https://www.awin1.com/awclick.php?mid=11660&id=2776410
            * Kaspersky (AWIN): https://www.awin1.com/awclick.php?mid=19487&id=2776410
            * ESET (AWIN): https://www.awin1.com/awclick.php?mid=18785&id=2776410
            * Surfshark (AWIN): https://www.awin1.com/awclick.php?mid=36608&id=2776410
          - CTA format: <a href=\"URL\" class=\"cta\" rel=\"nofollow sponsored\" target=\"_blank\">CTA text</a>
          - Outline CTA: <a href=\"URL\" class=\"cta cta-outline\" rel=\"nofollow sponsored\" target=\"_blank\">CTA text</a>
          - Rating format: <div class=\"rating\">⭐⭐⭐⭐⭐ 9.5/10</div>
          - Pros/cons: <div class=\"pros-cons\"><div class=\"pros\"><strong>Pros</strong>...</div><div class=\"cons\"><strong>Cons</strong>...</div></div>
          - NO emojis in CTA buttons
          - Add rel=\"nofollow sponsored\" to ALL affiliate links
          - Add rel=\"nofollow\" to non-affiliate external links
          - Include internal links to related articles on the site (use /posts/slug-name/ format)
          - End with a Related Guides section linking to 3-4 other articles
          - End with: *Last updated: $(date +'%B %Y').*

          Write the complete article now. Output ONLY the markdown content, nothing else."

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                "model": "claude-sonnet-4-5-20250929",
                "max_tokens": 8000,
                "messages": [{"role": "user", "content": $prompt}]
              }')")

          # Extract the content from the response
          ARTICLE=$(echo "$RESPONSE" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          if 'content' in data:
              for block in data['content']:
                  if block['type'] == 'text':
                      print(block['text'])
          elif 'error' in data:
              print(f'API ERROR: {data[\"error\"][\"message\"]}')
              sys.exit(1)
          ")

          if [ $? -ne 0 ]; then
            echo "Failed to generate article"
            exit 1
          fi

          # Write the article
          echo "$ARTICLE" > "$FILENAME"
          echo "Article written to $FILENAME"
          wc -w "$FILENAME"

      - name: Commit and push
        run: |
          git config user.name "Claude AI Bot"
          git config user.email "claude-bot@digitalshieldpro.com"
          FILENAME="content/posts/${{ github.event.inputs.slug }}.md"
          git add "$FILENAME"
          git commit -m "Add new article: ${{ github.event.inputs.topic }}

          Auto-generated by Claude AI via GitHub Actions.

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
          git push

      - name: Summary
        run: |
          FILENAME="content/posts/${{ github.event.inputs.slug }}.md"
          WORDS=$(wc -w < "$FILENAME")
          echo "## Article Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Topic:** ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ github.event.inputs.article_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** $FILENAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Words:** $WORDS" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://digitalshieldpro.com/posts/${{ github.event.inputs.slug }}/" >> $GITHUB_STEP_SUMMARY
